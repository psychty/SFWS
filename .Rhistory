fillOpacity = 1,
stroke = FALSE,
group = "Show number of CVD patients with<br>at least one A&E attendance") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$AE_perc_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(AE_any_bins == "20-25%", 8, ifelse(AE_any_bins == "25-30%", 10, ifelse(AE_any_bins == "30-35%", 12, ifelse(AE_any_bins == "35-40%", 14, ifelse(AE_any_bins == "40-45%", 16, NA))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease.Of these patients, ", format(CVD_by_practice$Any_ae, big.mark = ","), " (", round(CVD_by_practice$AE_Percent*100,1), "%) had at least one attendance to A&E in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$AE_sig_PCN), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$AE_sig_CCG), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one attendance: <Strong>",format(CVD_by_practice$One_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two attendances: <Strong>", format(CVD_by_practice$Two_ae, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three attendances: <Strong>", format(CVD_by_practice$Three_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more attendances: <Strong>", format(CVD_by_practice$Four_plus_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that attendances may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(AE_any_bins %in% c("30-35%", "35-40%", "40-45%"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$AE_sig_PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 8,
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease.Of these patients, ", format(CVD_by_practice$Any_ae, big.mark = ","), " (", round(CVD_by_practice$AE_Percent*100,1), "%) had at least one attendance to A&E in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$AE_sig_PCN), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$AE_sig_CCG), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one attendance: <Strong>",format(CVD_by_practice$One_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two attendances: <Strong>", format(CVD_by_practice$Two_ae, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three attendances: <Strong>", format(CVD_by_practice$Three_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more attendances: <Strong>", format(CVD_by_practice$Four_plus_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that attendances may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_number_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Emerg_any_bins_n == "Up to 75", 8, ifelse(Emerg_any_bins_n == "75-150", 10, ifelse(Emerg_any_bins_n == "150-225", 12, ifelse(Emerg_any_bins_n == "225-300", 14, ifelse(Emerg_any_bins_n == "300-375", 16, ifelse(Emerg_any_bins_n == "375-450", 18, NA)))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(AE_any_bins_n %in% c("225-300","300-375", "375-450"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_perc_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Emerg_any_bins == "5-10%", 10, ifelse(Emerg_any_bins == "10-15%", 12, ifelse(Emerg_any_bins == "15-20%", 14, ifelse(Emerg_any_bins == "20-25%", 16, NA)))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(Emerg_any_bins %in% c("15-20%", "20-25%"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_sig_PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 8,
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Primary Care Network",
labels = c("Crawley East", "Crawley West","Burgess Hill", "East Grinstead", "Haywards Heath", "Horsham"),
colors =  c("#436978","#38A9DC","#A03336","#C93A28","#FF8D7E","#F59630"),
opacity = 1,
group = "Show GP practices by PCN") %>%
addLegend(position = "bottomleft",
title = "Primary Care Network",
labels = c("Quintile 1 (least deprived 20%)", "Quintile 2", "Quintile 3", "Quintile 4", "Quintile 5 (most deprived 20%)"),
colors =  c("#F0FF30", "#E0FFA0", "#90FFB0", "#40E0FF", "#0000FF"),
opacity = 1,
group = "Show GP deprivation") %>%
addLegend(position = "bottomleft",
title = "Diagnosed CVD prevalence",
labels = c("5-7.5%", "7.5-10%", "10-12.5%", "12.5-15%", "15-17.5%"),
colors =  c("#07076f", "#bb37af","#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show prevalence of CVD") %>%
addLegend(position = "bottomleft",
title = "CVD prevalence compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show prevalence of CVD<br>compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Number of CVD patients with at least one<br>attendance to A&E in 12 months to November 2018",
labels = c("Up to 200", "200-400", "400-600", "600-800", "800-1,000"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show number of CVD patients with<br>at least one A&E attendance") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least one<br>attendance to A&E in 12 months to November 2018",
labels = c("20-25%", "25-30%", "30-35%", "35-40%", "40-45%"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least<br>one attendance to A&E in 12 months to<br>November 2018 compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Number of CVD patients with at least one<br>emergency inpatient admission in 12 months to November 2018",
labels = c("Up to 75", "75-150", "150-225", "225-300", "300-375", "375-450"),
colors =  c("#07076f", "#56106E", "#bb37af","#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least one<br>emergency inpatient admission in 12 months to November 2018",
labels = c("5-10%", "10-15%", "15-20%", "20-25%"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#edf424"),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least<br>one emergency inpatient admission in 12 months to<br>November 2018 compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN") %>%
addLayersControl(overlayGroups = c("Show GP practices by PCN", "Show GP deprivation", "Show prevalence of CVD", "Show prevalence of CVD<br>compared to PCN", "Show number of CVD patients with<br>at least one A&E attendance", "Show proportion of CVD patients with<br>at least one A&E attendance","Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN", "Show number of CVD patients with<br>at least one emergency inpatient admission", "Show proportion of CVD patients with<br>at least one emergency inpatient admission","Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN"),
options = layersControlOptions(collapsed = FALSE)) %>%
addSearchFeatures(targetGroups = 'Show GP practices by PCN',
options = searchFeaturesOptions(zoom = 12,
autoType = TRUE,
textPlaceholder = "Search Practice name",
textErr = "Practice not found",
collapsed = FALSE,
position = "topright",
openPopup = TRUE,
firstTipSubmit = TRUE,
autoCollapse = FALSE,
hideMarkerOnCollapse = FALSE)) %>%
addResetMapButton() %>%
addScaleBar(position = "bottomleft") %>%
addLegend(position = "bottomright",
title = "Clinical Commissioning Group",
labels = c("NHS Crawley CCG", "NHS Horsham and Mid Sussex CCG"),
colors =  c(Crawley_CCG_col, HMS_CCG_col),
opacity = .5) %>%
hideGroup(c("Show GP practices by PCN", "Show GP deprivation", "Show prevalence of CVD", "Show prevalence of CVD<br>compared to PCN", "Show number of CVD patients with<br>at least one A&E attendance", "Show proportion of CVD patients with<br>at least one A&E attendance","Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN", "Show number of CVD patients with<br>at least one emergency inpatient admission", "Show proportion of CVD patients with<br>at least one emergency inpatient admission","Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN"))
CVD_map
CVD_by_practice <- CVD_practice %>%
mutate(Prevalence_label = paste0(round(Percent*100,1), "% (95% CI: ", round(Percentage_LCI*100,1), "-", round(Percentage_UCI*100,1), "%)")) %>%
mutate(PCN_prevalence_label = paste0(round(PCN_percent*100,1), "% (95% CI: ", round(PCN_LCI*100,1), "-", round(PCN_UCI*100,1), "%)")) %>%
mutate(CCG_prevalence_label = paste0(round(CCG_percent*100,1), "% (95% CI: ", round(CCG_LCI*100,1), "-", round(CCG_UCI*100,1), "%)")) %>%
select(Area, Code, PCN, CCG, Patients, Disease,Number, Percent,`Deprivation score (IMD 2015)`,Address_1,Address_2,Address_3,Postcode,Contact_number, lat, long, Parent, Prevalence_label, PCN_prevalence_label, CCG_prevalence_label, Significance_PCN, Significance_CCG, Bins) %>%
mutate(Practice = substr(Area, 10, length(Area))) %>%
rename(Prevalence = Percent,
Prev_sig_PCN = Significance_PCN,
Prev_sig_CCG = Significance_CCG,
Prev_bins = Bins) %>%
select(-Area) %>%
mutate(PCN_colour = ifelse(PCN == "Crawley East", "#436978", ifelse(PCN == "Crawley West", "#38A9DC", ifelse(PCN == "Burgess Hill", "#A03336", ifelse(PCN == "East Grinstead", "#C93A28", ifelse(PCN == "Haywards Heath", "#FF8D7E", ifelse(PCN == "Horsham", "#F59630", NA))))))) %>%
mutate(Dep_quintile = factor(ntile(`Deprivation score (IMD 2015)`, 5), levels = rev(c(1,2,3,4,5)))) %>%
mutate(Dep_colour = ifelse(Dep_quintile  == 5, "#0000FF", ifelse(Dep_quintile == 4, "#40E0FF", ifelse(Dep_quintile == 3, "#90FFB0", ifelse(Dep_quintile == 2, "#E0FFA0", ifelse(Dep_quintile == 1, "#F0FF30", NA)))))) %>%
mutate(Practice_label = paste0(Practice, " (", Code, ")")) %>%
left_join(CVD_ae_practice[c("Code","0","1","2","3","4+","Any","Percent_any","Any_LCI","Any_UCI","PCN_percent","PCN_LCI","PCN_UCI","CCG_percent","CCG_LCI","CCG_UCI","Significance_PCN", "Significance_CCG","any_bins","any_bins_n")], by = "Code") %>%
rename(Zero_ae = `0`,
One_ae = `1`,
Two_ae = `2`,
Three_ae = `3`,
Four_plus_ae = `4+`,
Any_ae = Any,
Percent_any_ae = Percent_any) %>%
mutate(AE_label = paste0(round(Percent_any_ae *100,1), " (95% CI: ", round(Any_LCI *100,1), "-", round(Any_UCI *100,1), "%)")) %>%
mutate(AE_PCN_label = paste0(round(PCN_percent *100,1), " (95% CI: ", round(PCN_LCI *100,1), "-", round(PCN_UCI *100,1), "%)")) %>%
mutate(AE_CCG_label = paste0(round(CCG_percent *100,1), " (95% CI: ", round(CCG_LCI *100,1), "-", round(CCG_UCI *100,1), "%)")) %>%
select(-c(Any_LCI, Any_UCI, PCN_percent, PCN_LCI, PCN_UCI, CCG_percent, CCG_LCI, CCG_UCI)) %>%
rename(AE_Percent = Percent_any_ae,
AE_sig_PCN = Significance_PCN,
AE_sig_CCG = Significance_CCG,
AE_any_bins = any_bins,
AE_any_bins_n = any_bins_n) %>%
left_join(CVD_emerg_practice[c("Code","0","1","2","3","4+","Any","Percent_any","Any_LCI","Any_UCI","PCN_percent","PCN_LCI","PCN_UCI","CCG_percent","CCG_LCI","CCG_UCI","Significance_PCN", "Significance_CCG","any_bins","any_bins_n")], by = "Code") %>%
rename(Zero_admissions = `0`,
One_admissions = `1`,
Two_admissions = `2`,
Three_admissions = `3`,
Four_plus_admissions = `4+`,
Any_admissions = Any,
Percent_any_admissions = Percent_any) %>%
mutate(Emerg_label = paste0(round(Percent_any_admissions *100,1), " (95% CI: ", round(Any_LCI *100,1), "-", round(Any_UCI *100,1), "%)")) %>%
mutate(Emerg_PCN_label = paste0(round(PCN_percent *100,1), " (95% CI: ", round(PCN_LCI *100,1), "-", round(PCN_UCI *100,1), "%)")) %>%
mutate(Emerg_CCG_label = paste0(round(CCG_percent *100,1), " (95% CI: ", round(CCG_LCI *100,1), "-", round(CCG_UCI *100,1), "%)")) %>%
select(-c(Any_LCI, Any_UCI, PCN_percent, PCN_LCI, PCN_UCI, CCG_percent, CCG_LCI, CCG_UCI)) %>%
rename(Emerg_Percent = Percent_any_admissions,
Emerg_sig_PCN = Significance_PCN,
Emerg_sig_CCG = Significance_CCG,
Emerg_any_bins = any_bins,
Emerg_any_bins_n = any_bins_n) %>%
mutate(Prev_colour = factor(ifelse(Prev_bins == "5-7.5%", "#07076F", ifelse(Prev_bins == "7.5-10%", "#BB37AF", ifelse(Prev_bins == "10-12.5%", "#EE2966", ifelse(Prev_bins == "12.5-15%", "#F98C0A", ifelse(Prev_bins == "15-17.5%", "#EDF424", NA))))), levels = rev(c("#07076F","#BB37AF","#EE2966","#F98C0A","#EDF424")))) %>%
mutate(Prev_sig_PCN_colour = ifelse(Prev_sig_PCN == "Significantly lower", lower, ifelse(Prev_sig_PCN == "Similar", no_diff, ifelse(Prev_sig_PCN == "Significantly higher", higher, NA)))) %>%
mutate(Prev_sig_CCG_colour = ifelse(Prev_sig_CCG == "Significantly lower", lower, ifelse(Prev_sig_CCG == "Similar", no_diff, ifelse(Prev_sig_CCG == "Significantly higher", higher, NA)))) %>%
mutate(AE_number_colour = ifelse(AE_any_bins_n == "Up to 200", "#07076F", ifelse(AE_any_bins_n == "200-400", "#BB37AF", ifelse(AE_any_bins_n == "400-600", "#EE2966", ifelse(AE_any_bins_n == "600-800", "#F98C0A", ifelse(AE_any_bins_n == "800-1,000", "#EDF424", NA)))))) %>%
mutate(AE_perc_colour = ifelse(AE_any_bins == "20-25%", "#07076F", ifelse(AE_any_bins == "25-30%", "#BB37AF", ifelse(AE_any_bins == "30-35%", "#EE2966", ifelse(AE_any_bins == "35-40%", "#F98C0A", ifelse(AE_any_bins == "40-45%", "#EDF424", NA)))))) %>%
mutate(AE_sig_PCN_colour = ifelse(AE_sig_PCN == "Significantly lower", lower, ifelse(AE_sig_PCN == "Similar", no_diff, ifelse(AE_sig_PCN == "Significantly higher", higher, NA)))) %>%
mutate(AE_sig_CCG_colour = ifelse(AE_sig_CCG == "Significantly lower", lower, ifelse(AE_sig_CCG == "Similar", no_diff, ifelse(AE_sig_CCG == "Significantly higher", higher, NA)))) %>%
mutate(Emerg_number_colour = ifelse(Emerg_any_bins_n == "Up to 75", "#07076F", ifelse(Emerg_any_bins_n == "75-150", "#56106E", ifelse(Emerg_any_bins_n == "150-225", "#BB37AF", ifelse(Emerg_any_bins_n == "225-300", "#EE2966", ifelse(Emerg_any_bins_n == "300-375", "#F98C0A", ifelse(Emerg_any_bins_n == "375-450", "#EDF424", NA))))))) %>%
mutate(Emerg_perc_colour = ifelse(Emerg_any_bins == "5-10%", "#07076F", ifelse(Emerg_any_bins == "10-15%", "#BB37AF", ifelse(Emerg_any_bins == "15-20%", "#EE2966", ifelse(Emerg_any_bins == "20-25%", "#EDF424", NA))))) %>%
mutate(Emerg_sig_PCN_colour = ifelse(Emerg_sig_PCN == "Significantly lower", lower, ifelse(Emerg_sig_PCN == "Similar", no_diff, ifelse(Emerg_sig_PCN == "Significantly higher", higher, NA)))) %>%
mutate(Emerg_sig_CCG_colour = ifelse(Emerg_sig_CCG == "Significantly lower", lower, ifelse(Emerg_sig_CCG == "Similar", no_diff, ifelse(Emerg_sig_CCG == "Significantly higher", higher, NA))))
CVD_map <- leaflet(CVD_by_practice) %>%
addTiles(urlTemplate = "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution = "Data sources: Artemus. Boundary data © Crown copyright 2018. Index of multiple deprivation  - Department of Communities and Local Government<br>Zoom in/out using your mouse wheel or the plus (+) and minus (-) buttons. Click on an area or GP icon to find out more<br><font color='red'><Strong>Please refer to the static maps for size key. Each classification is different.</Strong></font>") %>%
addControl("<strong><font size = 1.5 color = 'red'>Use the buttons here to toggle different measures.</strong></font>",
position='topright',
className = "fieldset {border: 0;}") %>%
addPolygons(data = CCG_boundary,
stroke = TRUE,
color = c(Crawley_CCG_col, HMS_CCG_col),
weight = 2,
group = "Show CCG boundaries") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 6,
popup = paste0(""),
group = "Show GP practices by PCN") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Dep_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Dep_quintile == 1, 8, ifelse(Dep_quintile == 2, 10, ifelse(Dep_quintile == 3, 12, ifelse(Dep_quintile == 4, 14, ifelse(Dep_quintile == 5, 16, NA))))),
popup = paste0("nd"),
group = "Show GP deprivation") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(Dep_quintile %in% c(1,2,3), "#000000", "#FFFFFF"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show GP deprivation") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Prev_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Prev_bins == "5-7.5%", 8, ifelse(Prev_bins == "7.5-10%", 10, ifelse(Prev_bins == "10-12.5%", 12, ifelse(Prev_bins == "12.5-15%", 14, ifelse(Prev_bins == "15-17.5%", 16, NA))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. This is ", CVD_by_practice$Prevalence_label," of the patient population.<br><br>The prevalence in ", CVD_by_practice$Practice, " was ", tolower(CVD_by_practice$Prev_sig_PCN), ifelse(CVD_by_practice$Prev_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Prev_sig_CCG), ifelse(CVD_by_practice$Prev_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,"."),
group = "Show prevalence of CVD") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(Prev_bins %in% c("5-7.5%", "7.5-10%", "10-12.5%"), "#ffffff", "#000000"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show prevalence of CVD") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Prev_sig_PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 8,
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. This is ", CVD_by_practice$Prevalence_label," of the patient population.<br><br>The prevalence in ", CVD_by_practice$Practice, " was ", tolower(CVD_by_practice$Prev_sig_PCN), ifelse(CVD_by_practice$Prev_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Prev_sig_CCG), ifelse(CVD_by_practice$Prev_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,"."),
group = "Show prevalence of CVD<br>compared to PCN") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$AE_number_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(AE_any_bins_n == "Up to 200", 8, ifelse(AE_any_bins_n == "200-400", 10, ifelse(AE_any_bins_n == "400-600", 12, ifelse(AE_any_bins_n == "600-800", 14, ifelse(AE_any_bins_n == "800-1,000", 16, NA))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease.Of these patients, ", format(CVD_by_practice$Any_ae, big.mark = ","), " (", round(CVD_by_practice$AE_Percent*100,1), "%) had at least one attendance to A&E in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$AE_sig_PCN), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$AE_sig_CCG), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one attendance: <Strong>",format(CVD_by_practice$One_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two attendances: <Strong>", format(CVD_by_practice$Two_ae, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three attendances: <Strong>", format(CVD_by_practice$Three_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more attendances: <Strong>", format(CVD_by_practice$Four_plus_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that attendances may not be related to cardiovascular disease.</font></Strong>"),
group = "Show number of CVD patients with<br>at least one A&E attendance") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(AE_any_bins_n %in% c("400-600", "600-800", "800-1,000"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show number of CVD patients with<br>at least one A&E attendance") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$AE_perc_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(AE_any_bins == "20-25%", 8, ifelse(AE_any_bins == "25-30%", 10, ifelse(AE_any_bins == "30-35%", 12, ifelse(AE_any_bins == "35-40%", 14, ifelse(AE_any_bins == "40-45%", 16, NA))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease.Of these patients, ", format(CVD_by_practice$Any_ae, big.mark = ","), " (", round(CVD_by_practice$AE_Percent*100,1), "%) had at least one attendance to A&E in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$AE_sig_PCN), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$AE_sig_CCG), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one attendance: <Strong>",format(CVD_by_practice$One_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two attendances: <Strong>", format(CVD_by_practice$Two_ae, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three attendances: <Strong>", format(CVD_by_practice$Three_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more attendances: <Strong>", format(CVD_by_practice$Four_plus_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that attendances may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(AE_any_bins %in% c("30-35%", "35-40%", "40-45%"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$AE_sig_PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 8,
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease.Of these patients, ", format(CVD_by_practice$Any_ae, big.mark = ","), " (", round(CVD_by_practice$AE_Percent*100,1), "%) had at least one attendance to A&E in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$AE_sig_PCN), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the prevalence in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$AE_sig_CCG), ifelse(CVD_by_practice$AE_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one attendance: <Strong>",format(CVD_by_practice$One_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two attendances: <Strong>", format(CVD_by_practice$Two_ae, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three attendances: <Strong>", format(CVD_by_practice$Three_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more attendances: <Strong>", format(CVD_by_practice$Four_plus_ae, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_ae / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that attendances may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_number_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Emerg_any_bins_n == "Up to 75", 8, ifelse(Emerg_any_bins_n == "75-150", 10, ifelse(Emerg_any_bins_n == "150-225", 12, ifelse(Emerg_any_bins_n == "225-300", 14, ifelse(Emerg_any_bins_n == "300-375", 16, ifelse(Emerg_any_bins_n == "375-450", 18, NA)))))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(AE_any_bins_n %in% c("225-300","300-375", "375-450"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_perc_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = ~ifelse(Emerg_any_bins == "5-10%", 10, ifelse(Emerg_any_bins == "10-15%", 12, ifelse(Emerg_any_bins == "15-20%", 14, ifelse(Emerg_any_bins == "20-25%", 16, NA)))),
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircles(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = ~ifelse(Emerg_any_bins %in% c("15-20%", "20-25%"), "#000000", "#ffffff"),
radius = 5,
fillOpacity = 1,
stroke = FALSE,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addCircleMarkers(lng = CVD_by_practice$long,
lat = CVD_by_practice$lat,
color = CVD_by_practice$Emerg_sig_PCN_colour,
stroke = FALSE,
label = CVD_by_practice$Practice_label,
fillOpacity = 1,
radius = 8,
popup = paste0("<strong>",CVD_by_practice$Practice_label, "<br>Patients (all ages): ", format(CVD_by_practice$Patients, big.mark = ","),"</strong><br><br>In the 12 months to November 2018,<font color='red'><Strong>", format(CVD_by_practice$Number, big.mark = ","),"</font></strong> patients were on lists for cardiovascular disease. Of these patients, ", format(CVD_by_practice$Any_admissions, big.mark = ","), " (", round(CVD_by_practice$Emerg_Percent*100,1), "%) had at least one emergency inpatient admission in the 12 months to November 2018.<br><br>As a proportion, this is ", tolower(CVD_by_practice$Emerg_sig_PCN), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the proportion in the ", CVD_by_practice$PCN, " PCN and ", tolower(CVD_by_practice$Emerg_sig_CCG), ifelse(CVD_by_practice$Emerg_sig_PCN == "Similar", " to ", " than "), " the ", CVD_by_practice$CCG,".<br><br><Strong>Number of patients with...</Strong><br>...one admission: <Strong>",format(CVD_by_practice$One_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$One_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...two admissions: <Strong>", format(CVD_by_practice$Two_admissions, big.mark = ","),  "</Strong> (", round((CVD_by_practice$Two_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...three admissions: <Strong>", format(CVD_by_practice$Three_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Three_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br>...four or more admissions: <Strong>", format(CVD_by_practice$Four_plus_admissions, big.mark = ","), "</Strong> (", round((CVD_by_practice$Four_plus_admissions / CVD_by_practice$Number) *100, 1), "% of CVD patients)<br><br><font color = 'red'><Strong>It should be noted that hospital admissions may not be related to cardiovascular disease.</font></Strong>"),
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Primary Care Network",
labels = c("Crawley East", "Crawley West","Burgess Hill", "East Grinstead", "Haywards Heath", "Horsham"),
colors =  c("#436978","#38A9DC","#A03336","#C93A28","#FF8D7E","#F59630"),
opacity = 1,
group = "Show GP practices by PCN") %>%
addLegend(position = "bottomleft",
title = "Primary Care Network",
labels = c("Quintile 1 (least deprived 20%)", "Quintile 2", "Quintile 3", "Quintile 4", "Quintile 5 (most deprived 20%)"),
colors =  c("#F0FF30", "#E0FFA0", "#90FFB0", "#40E0FF", "#0000FF"),
opacity = 1,
group = "Show GP deprivation") %>%
addLegend(position = "bottomleft",
title = "Diagnosed CVD prevalence",
labels = c("5-7.5%", "7.5-10%", "10-12.5%", "12.5-15%", "15-17.5%"),
colors =  c("#07076f", "#bb37af","#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show prevalence of CVD") %>%
addLegend(position = "bottomleft",
title = "CVD prevalence compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show prevalence of CVD<br>compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Number of CVD patients with at least one<br>attendance to A&E in 12 months to November 2018",
labels = c("Up to 200", "200-400", "400-600", "600-800", "800-1,000"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show number of CVD patients with<br>at least one A&E attendance") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least one<br>attendance to A&E in 12 months to November 2018",
labels = c("20-25%", "25-30%", "30-35%", "35-40%", "40-45%"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one A&E attendance") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least<br>one attendance to A&E in 12 months to<br>November 2018 compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN") %>%
addLegend(position = "bottomleft",
title = "Number of CVD patients with at least one<br>emergency inpatient admission in 12 months to November 2018",
labels = c("Up to 75", "75-150", "150-225", "225-300", "300-375", "375-450"),
colors =  c("#07076f", "#56106E", "#bb37af","#ee2966", "#F98C0A","#edf424"),
opacity = 1,
group = "Show number of CVD patients with<br>at least one emergency inpatient admission") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least one<br>emergency inpatient admission in 12 months to November 2018",
labels = c("5-10%", "10-15%", "15-20%", "20-25%"),
colors =  c("#07076f", "#bb37af", "#ee2966", "#edf424"),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission") %>%
addLegend(position = "bottomleft",
title = "Proportion of CVD patients with at least<br>one emergency inpatient admission in 12 months to<br>November 2018 compared to PCN",
labels = c("Significantly higher", "Similar", "Significantly lower"),
colors =  c(higher, no_diff, lower),
opacity = 1,
group = "Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN") %>%
addLayersControl(overlayGroups = c("Show GP practices by PCN", "Show GP deprivation", "Show prevalence of CVD", "Show prevalence of CVD<br>compared to PCN", "Show number of CVD patients with<br>at least one A&E attendance", "Show proportion of CVD patients with<br>at least one A&E attendance","Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN", "Show number of CVD patients with<br>at least one emergency inpatient admission", "Show proportion of CVD patients with<br>at least one emergency inpatient admission","Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN"),
options = layersControlOptions(collapsed = FALSE)) %>%
addSearchFeatures(targetGroups = 'Show GP practices by PCN',
options = searchFeaturesOptions(zoom = 12,
autoType = TRUE,
textPlaceholder = "Search Practice name",
textErr = "Practice not found",
collapsed = FALSE,
position = "topright",
openPopup = TRUE,
firstTipSubmit = TRUE,
autoCollapse = FALSE,
hideMarkerOnCollapse = FALSE)) %>%
addResetMapButton() %>%
addScaleBar(position = "bottomleft") %>%
addLegend(position = "bottomright",
title = "Clinical Commissioning Group",
labels = c("NHS Crawley CCG", "NHS Horsham and Mid Sussex CCG"),
colors =  c(Crawley_CCG_col, HMS_CCG_col),
opacity = .5) %>%
hideGroup(c("Show GP practices by PCN", "Show GP deprivation", "Show prevalence of CVD", "Show prevalence of CVD<br>compared to PCN", "Show number of CVD patients with<br>at least one A&E attendance", "Show proportion of CVD patients with<br>at least one A&E attendance","Show proportion of CVD patients with<br>at least one A&E attendance compared to PCN", "Show number of CVD patients with<br>at least one emergency inpatient admission", "Show proportion of CVD patients with<br>at least one emergency inpatient admission","Show proportion of CVD patients with<br>at least one emergency inpatient admission<br>compared to PCN"))
CVD_map
# SFWS_Action_plan
library(tidyverse)
library(readxl)
setwd("C:/Users/Rich/Documents/sfws-project-folder")
capwords = function(s, strict = FALSE) {
cap = function(s) paste(toupper(substring(s, 1, 1)),
{s = substring(s, 2); if(strict) tolower(s) else s},sep = "", collapse = " " )
sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))}
AP_raw <- read_excel("./SFWS Action Plan.xlsx") %>%
mutate(timeframe_short = ifelse(grepl("S", timeframe, ignore.case = TRUE) == TRUE, "shortterm", NA),
timeframe_medium = ifelse(grepl("M", timeframe, ignore.case = TRUE) == TRUE, "mediumterm", NA),
timeframe_long = ifelse(grepl("L", timeframe, ignore.case = TRUE) == TRUE, "longterm", NA)) %>%
mutate(ongoing = ifelse(grepl("S", timeframe, ignore.case = TRUE) == TRUE & grepl("M", timeframe, ignore.case = TRUE) == TRUE & grepl("L", timeframe, ignore.case = TRUE) == TRUE, "ongoing", NA))  %>%
mutate(timeframe_js = trimws(gsub("NA", "", paste(timeframe_short, timeframe_medium, timeframe_long, ongoing, sep = " ")), which = "left")) %>%
mutate(level_individual = ifelse(grepl("I", level, ignore.case = TRUE) == TRUE, "individual", NA),
level_community = ifelse(grepl("C", level, ignore.case = TRUE) == TRUE, "community", NA),
level_place = ifelse(grepl("P", level, ignore.case = TRUE) == TRUE, "place", NA)) %>%
mutate(level_js = trimws(gsub("NA", "", paste(level_individual, level_community, level_place, sep = " ")), which = "left"))
write.csv(AP_raw, "./actionplan_raw.csv", row.names = FALSE, na = "")
# We have to split the code here because the next part calls AP_raw which is not created until the end of the command
AP_raw <- AP_raw %>%
mutate(how_many_tf = rowSums(!is.na(AP_raw[c("timeframe_short", "timeframe_medium", "timeframe_long", "ongoing")]))) %>%
mutate(timeframe_label = ifelse(how_many_tf == 4, "Ongoing",
ifelse(how_many_tf == 2, trimws(gsub("NA and", "", paste(timeframe_short, timeframe_medium, timeframe_long, sep = " and ")), which = "left"),
ifelse(how_many_tf == 1, timeframe_js, NA)))) %>%
mutate(timeframe_label = gsub("NA ", "", timeframe_label)) %>%
mutate(timeframe_label = gsub("and NA", "", timeframe_label)) %>%
mutate(timeframe_label = gsub("shortterm", "Short term", timeframe_label)) %>%
mutate(timeframe_label = gsub("mediumterm", "Medium term", timeframe_label)) %>%
mutate(timeframe_label = gsub("longterm", "Long term", timeframe_label)) %>%
mutate(how_many_levels = rowSums(!is.na(AP_raw[c("level_individual", "level_community", "level_place")]))) %>%
mutate(levels_label = ifelse(how_many_levels == 3, "All levels",
ifelse(how_many_levels == 2, trimws(gsub("NA and", "", paste(capwords(level_individual, strict = TRUE), capwords(level_community, strict = TRUE), capwords(level_place, strict = TRUE), sep = " and ")), which = "left"),
ifelse(how_many_levels == 1, capwords(level_js, strict = TRUE), NA)))) %>%
mutate(levels_label = gsub("NA ", "", levels_label)) %>%
mutate(partner_label = ifelse(grepl(",", partners, ignore.case = TRUE) == TRUE, "Multiple partners", partners)) %>%
mutate(partner_label = gsub("Western Sussex Hospitals NHS Foundation Trust", '<abbr title="Western Sussex Hospital NHS Foundation Trust">WSHFT</abbr>', partner_label)) %>%
mutate(partner_js = partners) %>%
mutate(partner_js = gsub("Trading Standards", "trading_standards", partner_js)) %>%
mutate(partner_js = gsub("Local Maternity System", "lms", partner_js)) %>%
mutate(partner_js = gsub("Wellbeing programme", "wellbeing_programme", partner_js, ignore.case = TRUE)) %>%
mutate(partner_js = gsub("Fire Service", "fire_service", partner_js)) %>%
mutate(partner_js = gsub("Public Health", "public_health", partner_js)) %>%
mutate(partner_js = gsub("Maternity at Western Hospitals", "maternity wsht", partner_js)) %>%
mutate(partner_js = gsub("Health4Families", "h4f", partner_js)) %>%
mutate(partner_js = gsub("Prisons", "prisons", partner_js)) %>%
mutate(partner_js = gsub("Communities", "communities", partner_js)) %>%
mutate(partner_js = gsub("Western Sussex Hospitals NHS Foundation Trust", "wsht", partner_js)) %>%
mutate(partner_js = gsub("Sussex Community NHS Foundation Trust", "scft", partner_js)) %>%
mutate(partner_js = gsub("Primary Care", "primary_care", partner_js)) %>%
mutate(partner_js = gsub("District & Boroughs", "dandb", partner_js)) %>%
mutate(partner_js = gsub(",", "", partner_js))
AP_ready <- AP_raw %>%
select(ap_number, ap_title, ap_text, success, progress, achieved, partners,partner_label, partner_js, hic_number, hic_label, hic_class, timeframe_js, timeframe_label, level_js, levels_label) %>%
mutate(div_1 = gsub("NA", "", paste('<div class = "grid-item', hic_class, timeframe_js, level_js, partner_js,'">', sep = " "))) %>%
mutate(div_2 = gsub("NA", "", paste0('<p class = "ap_number">',ap_number,'</p>'))) %>%
mutate(div_3 = gsub("NA", "", paste0('<p class = "ap_title">', ap_title,'</p>'))) %>%
mutate(div_4 = gsub("NA", "", paste0('<p class = "ap_text">', ap_text,'</p>'))) %>%
mutate(div_5 = gsub("NA", "", paste0('<p class = "success">', success,'</p>'))) %>%
mutate(div_6 = gsub("NA", "", paste0('<p class = "partner_label">', partner_label,'</p>'))) %>%
mutate(div_7 = gsub("NA", "", paste0('<p class = "hic_number">', hic_number,'</p>'))) %>%
mutate(div_8 = gsub("NA", "", paste0('<p class = "hic_label">', hic_label,'</p>'))) %>%
mutate(div_9 = gsub("NA", "", paste0('<p class = "progress">', progress,'</p>'))) %>%
mutate(div_10 = gsub("NA", "", paste0('<p class = "achieved">', achieved,'</p>'))) %>%
mutate(div_11 = gsub("NA", "", paste0('<p class = "timeframe_label">', timeframe_label,'</p>'))) %>%
mutate(div_12 = gsub("NA", "", paste0('<p class = "levels_label">', levels_label,'</p>'))) %>%
mutate(div_13 = paste0('<div class="tooltip_',hic_class,'">'),
div_14 = paste0("<h2>",ap_title, "</h2>"),
div_15 = paste0("<p>", ap_text, "</p>"),
div_16 = paste0("<h3>What will success look like?</h3>"),
div_17 = paste0("<p>", success, "</p>"),
div_18 = paste0("<h3>Who are key partners for this action?</h3>"),
div_19 = paste0("<p>",partners,"</p>"),
div_20 = "</div>")
# We could include links or an update of progress etc.
AP_t <- gather(as.data.frame(t(AP_ready[c("div_1","div_2","div_3","div_4","div_5","div_6","div_7","div_8","div_9","div_10","div_11","div_12","div_13","div_14","div_15","div_16","div_17","div_18","div_19","div_20","div_20")])))
write.csv(AP_t[c("value")], "./actionplan_html.csv", row.names = FALSE)
